<!DOCTYPE html>
<html>

<head>
    <!-- Required meta tags always come first -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="description" content="CAS - Enterprise Single Sign-On for the Web"/>
    <meta name="keywords" content="authentication, login, cas, central authentication service, web, java, protocol, thymeleaf,
                   open source, boot, spring, authorization, google, facebook, twitter, higher-ed, enterprise,
                   access management, single signon, sso, RBAC, ABAC, attributes, SAML, OpenID, openid connect,
                   JWT, ADFS"/>
    <meta name="robots" content="index,follow"/>

    
    

        
    


    

    <script>
        ((i, s, o, g, r, a, m) => {
            i['GoogleAnalyticsObject'] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o),
                m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m)
        })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

        ga('create', 'UA-83384532-2', 'auto');
        ga('send', 'pageview');

    </script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.3/css/all.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css@3"/>

    <link rel="stylesheet" type="text/css" media="screen" href="../../stylesheets/stylesheet.css">
    <link rel="stylesheet" type="text/css" media="print" href="../../stylesheets/print.css">

    <link href='https://fonts.googleapis.com/css?family=Lato:400,300,700' rel='stylesheet'>
    <link href='https://fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic&subset=latin-ext,latin' rel='stylesheet'>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@100;200;300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css" rel="stylesheet">

    <title>CAS - X.509 Authentication</title>

</head>

<body>
<!-- HEADER -->
<header class="hidden-sm-down">
    <div class="container">
        <div class="row">
            <div class="col-xs-4 col-md-2">
                <a href="../../index.html">
                    <img class="undecorated" src="../../images/cas_logo.png"/>
                </a>
            </div>
            <div class="col-xs-8 col-md-6">
                <h1>Enterprise Single Sign-On for All</h1>
            </div>
            <div class="hidden-sm-down col-md-4">
                <a id="forkme_banner" href="https://github.com/apereo/cas">View on GitHub</a>
            </div>

        </div>
    </div>
</header>

<!-- NAVBAR -->

<nav class="navbar navbar-expand-md navbar-dark bg-primary bg-dark">
    <div class="container">
        <button class="navbar-toggler collapsed" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarsExample04" aria-controls="navbarsExample04" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="navbar-collapse collapse" id="navbarsExample04">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item active"><a href="../../index.html" class="zoom nav-link">Home</a></li>
                <li class="nav-item"><a href="https://github.com/apereo/cas/releases" class="zoom nav-link">Releases</a></li>
                <li class="nav-item"><a href="../../Support.html" class="zoom nav-link">Support</a></li>
                <li class="nav-item"><a href="../../Mailing-Lists.html" class="zoom nav-link">Mailing Lists</a></li>
                <li class="nav-item">
                    <a class="zoom nav-link" href="../../Demos.html">Demos</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="zoom nav-link dropdown-toggle mr-md-2" href="#" id="cas-versions" data-bs-toggle="dropdown"
                       aria-haspopup="true" aria-expanded="false">Versions</a>
                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="cas-versions">
                        
                        
                        <a class="dropdown-item" href="/cas/development/">Development</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/6.6.x/">v6.6.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/6.5.x/">v6.5.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/6.4.x/">v6.4.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/6.3.x/">v6.3.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/6.2.x/">v6.2.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/6.1.x/">v6.1.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/6.0.x/">v6.0.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/5.3.x/">v5.3.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/5.2.x/">v5.2.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/5.1.x/">v5.1.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/5.0.x/">v5.0.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/4.2.x/">v4.2.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/4.1.x/">v4.1.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/4.0.x/">v4.0.x</a>
                        
                        

                    </div>
                </li>
                <li class="nav-item"><a href="https://apereo.github.io" target="_blank" class="zoom nav-link">Blog</a></li>
            </ul>

        </div>

    </div>
</nav>


<div class="container-fluid">
    <div class="row flex-xl-nowrap">
        <div class="col-12 col-md-3 col-xl-2 docs-sidebar pb-5" id="sidebar"></div>


        <div class="d-none d-xl-block col-xl-2 docs-toc">
    <div id="pageContents">
        <ul class="section-nav"></ul>
    </div>
</div>


        <main class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 cas-docs-content" role="main">


            

            <section>
                <nav id="docsNavBar">
                    <span id="toolbarIcons"></span>
                </nav>

                <div id="cas-docs-container">
                    <h1 id="x509-authentication">X.509 Authentication</h1>

<p>CAS X.509 authentication components provide a mechanism to authenticate users who present client certificates during
the SSL/TLS handshake process. The X.509 components require configuration outside the CAS application since the
SSL handshake happens outside the servlet layer where the CAS application resides. There is no particular requirement
on deployment architecture (i.e. Apache reverse proxy, load balancer SSL termination) other than any client
certificate presented in the SSL handshake be accessible to the servlet container as a request attribute named
<code class="language-plaintext highlighter-rouge">javax.servlet.request.X509Certificate</code>. This happens naturally for configurations that terminate SSL connections
directly at the servlet container and when using <code class="language-plaintext highlighter-rouge">Apache/mod_jk</code>; for other architectures it may be necessary to do
additional work.</p>

<p>CAS can be configured to extract an X509 certificate from a header created by a proxy running in front of CAS.</p>
<h2 id="overview">Overview</h2>

<p>Certificates are exchanged as part of the SSL (also called TLS) initialization that occurs when any browser connects to an <code class="language-plaintext highlighter-rouge">https</code> website.
A certain number of public CA certificates are preinstalled in each browser. It is assumed that:</p>

<ul>
  <li>Your organization is already able to generate and distribute certificates that a user can install in their browser</li>
  <li>Somewhere in that certificate there is a field that contains the Principal name or can be easily mapped to the Principal name that CAS can use.</li>
</ul>

<p>The remaining problem is to make sure that the browsers, servers and Java are all prepared to support these institutional certificates and, ideally,
that these institutional certificates will be the only ones exchanged when a browser connects to CAS.</p>

<h2 id="flow">Flow</h2>

<p>When a browser connects to CAS over an https: URL, the server identifies itself by sending its own certificate. The browser must already have installed a certificate identifying and trusting the CA that issued the CAS Server certificate. If the browser is not already prepared to trust the CAS server, then an error message pops up saying the server is not trusted.</p>

<p>After the Server sends the certificate that identifies itself, it then can then send a list of names of Certificate Authorities from which it is willing to accept certificates. Ideally, this list will include only one name; the name of the internal institutional CA that issues internal intranet-only certificates that internally contain a field with the CAS Principal name.</p>

<p>A user may install any number of certificates into the browser from any number of CA’s. If only one of these certificates comes from a CA named in the list of acceptable CA’s sent by the server, then most browsers will automatically send that one certificate without asking, and some can be configured in to not ask when there is only one possible choice. This presents a user experience where CAS becomes transparent to the user after some initial setup and the login happens automatically. However, if the server hosting CAS sends more than one CA name in the list and that matches more than one certificate on the browser, then the user will get prompted to choose a Certificate from the list. A user interaction defeats much of the purpose of certificates in CAS.</p>

<p>Note that CAS does not control this exchange. It is handled by the underlying server. You may not have the control to require the server to vend only one CA name when a browser visits CAS. So if you want to use X.509 certificates in CAS, you should consider this requirement when choosing the hosting environment. The ideal situation is to select a server that can identify itself with a public certificate issued by something like VeriSign or InCommon but then require the client certificate only be issued by the internal corporate/campus authority.</p>

<p>When CAS gets control, a user certificate may have been presented by the browser and be stored in the request. The CAS X.509 authentication machinery examines that certificate and verifies that it was issued by the trusted institutional authority. Then CAS searches through the fields of the certificate to identify one or more fields that can be turned into the principal identifier that the applications expect.</p>

<p>While an institution can have one certificate authority that issues certificates to employees, clients, machines, services, and devices, it is more common for the institution to have a single “root” certificate authority that in its entire existence only issues a handful of certificates. Each of these certificates identifies a secondary Certificate Authority that issues a particular category of certificates (to students, staff, servers, etc.). It is possible to configure CAS to trust the root Authority and, implicitly, all the secondary authorities that it creates. This, however, makes CAS only as secure as the least reliable secondary Certificate Authority created by the institution. At some point in the future, some manager will buy a product that requires a new class of certificates. He will ask to create a Certificate Authority that vends these certificates to the machines running this new product. He will then turn administration of this mess over to a junior programmer or consultant. If CAS trusts any certificate issued by any Authority created by the root, it will trust a fraudulent certificate forged by someone who has acquired control of what was intended to be a special purpose, isolated CA. Therefore, it is better to configure CAS to only accept certificates from the one secondary CA specifically expected to issue credentials to individuals, instead of trusting the institutional root CA.</p>

<h2 id="configuration">Configuration</h2>

<p>X.509 support is enabled by including the following dependency in the WAR overlay:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.apereo.cas<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>cas-server-support-x509-webflow<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>${cas.version}<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>The X.509 handler technically performs additional checks <em>after</em> the real SSL client authentication process performed
by the Web server terminating the SSL connection. Since an SSL peer may be configured to accept a wide range of
certificates, the CAS X.509 handler provides a number of properties that place additional restrictions on
acceptable client certificates.</p>

<p>To see the relevant list of CAS properties, please <a href="Configuration-Properties.html#x509-authentication">review this guide</a>.</p>

<h2 id="web-server-configuration">Web Server Configuration</h2>

<p>X.509 configuration requires substantial configuration outside the CAS Web application. The configuration of Web
server SSL components varies dramatically with software and is outside the scope of this document. We offer some
general advice for SSL configuration:</p>

<ul>
  <li>Configuring SSL components for optional client certificate behavior generally provides better user experience.
Requiring client certificates prevents SSL negotiation in cases where the certificate is not present, which prevents
user-friendly server-side error messages.</li>
  <li>Accept certificates only from trusted issuers, generally those within your PKI.</li>
  <li>Specify all certificates in the certificate chain(s) of allowed issuers.</li>
</ul>

<h3 id="apache-tomcat">Apache Tomcat</h3>

<p>Anything said here extends the <a href="https://tomcat.apache.org/tomcat-8.0-doc/ssl-howto.html">Apache Tomcat reference for SSL</a>.</p>

<p>The Tomcat server is configured in <code class="language-plaintext highlighter-rouge">$CATALINA_HOME/conf/server.xml</code> with one or more <code class="language-plaintext highlighter-rouge">&lt;Connector&gt; elements</code>. Each of these elements defines one port number on which Tomcat will listen for requests. Connectors that support SSL are configured with one or two files that represent a collection of X.509 certificates.</p>

<ul>
  <li>
    <p>The <code class="language-plaintext highlighter-rouge">keystoreFile</code> is a collection of X.509 certificates one of which Tomcat will use to identify itself to Browsers. This certificate contains the DNS name of the server on which Tomcat is running which the HTTP client will have used as the server name part of the URL. It is possible to use a file that contains multiple certificates (in which case Tomcat will use the certificate stored under the alias “Tomcat” or, if that is not found, will use the first certificate it finds that also has an associated private key). However, to assure that no mistakes are made it is sensible practice to use a file that has only the one host certificate, plus of course its private key and chain of parent Certificate Authorities.</p>
  </li>
  <li>
    <p>The <code class="language-plaintext highlighter-rouge">truststoreFile</code> is a collection of X.509 certificates representing Certificate Authorities from which Tomcat is willing to accept user certificates. Since the <code class="language-plaintext highlighter-rouge">keystoreFile</code> contains the CA that issued the certificate identifying the server, the <code class="language-plaintext highlighter-rouge">truststoreFile</code> and <code class="language-plaintext highlighter-rouge">keystoreFile</code> could be the same in a CAS configuration where the URL (actually the port) that uses X.509 authentication is not the well know widely recognized URL for interactive (userid/password form) login, and therefore the only CA that it trusts is the institutional internal CA.</p>
  </li>
</ul>

<p>One strategy if you are planning to support both X.509 and userid/password validation through the same port is to put a public (VeriSign, Thawte) certificate for this server in the <code class="language-plaintext highlighter-rouge">keystoreFile</code>, but then put only the institutional internal CA certificate in the <code class="language-plaintext highlighter-rouge">truststoreFile</code>. Logically and in all the documentation, the Certificate Authority that issues the certificate to the server which the browser trusts is completely and logically independent of the Certificate Authority that issues the certificate to the user which the server then trusts. Java keeps them separate, Tomcat keeps them separate, and browsers should not be confused if, during SSL negotiation, the server requests a user certificate from a CA other than the one that issued the server’s own identifying certificate. In this configuration, the Server issues a public certificate every browser will accept and the browser is strongly urged to send only a private institutional certificate that can be mapped to a Principal name.</p>

<div class="alert alert-info"><strong>Almost There</strong><p>If you previously configured CAS without X.509 authentication, then you probably have the `keystoreFile` already configured and
loaded with a certificate identifying this server. All you need to add is the `truststoreFile` part.</p></div>

<p>The configured connector will look something like:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="c">&lt;!-- Define a SSL HTTP/1.1 Connector on port 443 --&gt;</span>
<span class="c">&lt;!-- if you do not specify a truststoreFile, then the default java "cacerts" truststore will be used--&gt;</span>
<span class="nt">&lt;Connector</span> <span class="na">port=</span><span class="s">"443"</span>
    <span class="na">maxHttpHeaderSize=</span><span class="s">"8192"</span>
    <span class="na">maxThreads=</span><span class="s">"150"</span>
    <span class="na">minSpareThreads=</span><span class="s">"25"</span>
    <span class="na">maxSpareThreads=</span><span class="s">"75"</span>
    <span class="na">enableLookups=</span><span class="s">"false"</span>
    <span class="na">disableUploadTimeout=</span><span class="s">"true"</span>
    <span class="na">acceptCount=</span><span class="s">"100"</span>
    <span class="na">scheme=</span><span class="s">"https"</span>
    <span class="na">secure=</span><span class="s">"true"</span>
    <span class="na">clientAuth=</span><span class="s">"want"</span>
    <span class="na">sslProtocol=</span><span class="s">"TLS"</span>
    <span class="na">keystoreFile=</span><span class="s">"/path/to/keystore.jks"</span>
    <span class="na">keystorePass=</span><span class="s">"secret"</span>
    <span class="na">truststoreFile=</span><span class="s">"/path/to/myTrustStore.jks"</span>
    <span class="na">truststorePass=</span><span class="s">"secret"</span> <span class="nt">/&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">clientAuth="want"</code> tells Tomcat to request that the browser provide a user certificate if one is available. If you want to force the use of user certificates, replace <code class="language-plaintext highlighter-rouge">"want"</code> with <code class="language-plaintext highlighter-rouge">"true"</code>.
If you specify <code class="language-plaintext highlighter-rouge">"want"</code> and the browser does not have a certificate, then CAS may forward the request to the login form.</p>

<p>The keystore can be in <code class="language-plaintext highlighter-rouge">JKS</code> or <code class="language-plaintext highlighter-rouge">PKCS12</code> format when using Tomcat. When using both <code class="language-plaintext highlighter-rouge">PKCS12</code> and JKS keystore types then you should specify the type of each keystore by using the <code class="language-plaintext highlighter-rouge">keystoreType</code> and <code class="language-plaintext highlighter-rouge">truststoreType</code> attributes.</p>

<p>You may import the certificate of the institutional Certificate Authority (the one that issues User certificates) using the command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c"># Create a blank keystore to start from scratch if needed</span>
<span class="c"># keytool -genkey -keyalg RSA -alias "selfsigned" -keystore myTrustStore.jks -storepass "secret" -validity 360</span>
<span class="c"># keytool -delete -alias "selfsigned" -keystore myTrustStore.jks</span>

keytool <span class="nt">-import</span> <span class="nt">-alias</span> myAlias <span class="nt">-keystore</span> /path/to/myTrustStore.jks <span class="nt">-file</span> certificateForInstitutionalCA.crt
</pre></td></tr></tbody></table></code></pre></div></div>

                </div>
            </section>
        </main>
    </div>
</div>


<footer>
    <div class="container">
        CAS is supported by the <a href="https://www.apereo.org/">Apereo Foundation</a>.
    </div>
</footer>

<script>
    let pageSection = '';
</script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.3.2/js/tether.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js"></script>

<script src="../../javascripts/URI.js"></script>
<script src="../../javascripts/main.js"></script>

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@docsearch/js@3"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
</body>

</html>

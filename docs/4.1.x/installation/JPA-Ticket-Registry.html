<!DOCTYPE html>
<html>

<head>
    <!-- Required meta tags always come first -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="description" content="CAS - Enterprise Single Sign-On for the Web"/>
    <meta name="keywords" content="authentication, login, cas, central authentication service, web, java, protocol, thymeleaf,
                   open source, boot, spring, authorization, google, facebook, twitter, higher-ed, enterprise,
                   access management, single signon, sso, RBAC, ABAC, attributes, SAML, OpenID, openid connect,
                   JWT, ADFS"/>
    <meta name="robots" content="index,follow"/>

    
    

        
    


    

    <script>
        ((i, s, o, g, r, a, m) => {
            i['GoogleAnalyticsObject'] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o),
                m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m)
        })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

        ga('create', 'UA-83384532-2', 'auto');
        ga('send', 'pageview');

    </script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.3/css/all.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css@3"/>

    <link rel="stylesheet" type="text/css" media="screen" href="../../stylesheets/stylesheet.css">
    <link rel="stylesheet" type="text/css" media="print" href="../../stylesheets/print.css">

    <link href='https://fonts.googleapis.com/css?family=Lato:400,300,700' rel='stylesheet'>
    <link href='https://fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic&subset=latin-ext,latin' rel='stylesheet'>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@100;200;300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css" rel="stylesheet">

    <title>CAS - JPA Ticket Registry</title>

</head>

<body>
<!-- HEADER -->
<header class="hidden-sm-down">
    <div class="container">
        <div class="row">
            <div class="col-xs-4 col-md-2">
                <a href="../../index.html">
                    <img class="undecorated" src="../../images/cas_logo.png"/>
                </a>
            </div>
            <div class="col-xs-8 col-md-6">
                <h1>Enterprise Single Sign-On for All</h1>
            </div>
            <div class="hidden-sm-down col-md-4">
                <a id="forkme_banner" href="https://github.com/apereo/cas">View on GitHub</a>
            </div>

        </div>
    </div>
</header>

<!-- NAVBAR -->

<nav class="navbar navbar-expand-md navbar-dark bg-primary bg-dark">
    <div class="container">
        <button class="navbar-toggler collapsed" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarsExample04" aria-controls="navbarsExample04" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="navbar-collapse collapse" id="navbarsExample04">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item active"><a href="../../index.html" class="zoom nav-link">Home</a></li>
                <li class="nav-item"><a href="https://github.com/apereo/cas/releases" class="zoom nav-link">Releases</a></li>
                <li class="nav-item"><a href="../../Support.html" class="zoom nav-link">Support</a></li>
                <li class="nav-item"><a href="../../Mailing-Lists.html" class="zoom nav-link">Mailing Lists</a></li>
                <li class="nav-item">
                    <a class="zoom nav-link" href="../../Demos.html">Demos</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="zoom nav-link dropdown-toggle mr-md-2" href="#" id="cas-versions" data-bs-toggle="dropdown"
                       aria-haspopup="true" aria-expanded="false">Versions</a>
                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="cas-versions">
                        
                        
                        <a class="dropdown-item" href="/cas/development/">Development</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/6.6.x/">v6.6.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/6.5.x/">v6.5.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/6.4.x/">v6.4.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/6.3.x/">v6.3.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/6.2.x/">v6.2.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/6.1.x/">v6.1.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/6.0.x/">v6.0.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/5.3.x/">v5.3.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/5.2.x/">v5.2.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/5.1.x/">v5.1.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/5.0.x/">v5.0.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/4.2.x/">v4.2.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/4.1.x/">v4.1.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/4.0.x/">v4.0.x</a>
                        
                        

                    </div>
                </li>
                <li class="nav-item"><a href="https://apereo.github.io" target="_blank" class="zoom nav-link">Blog</a></li>
            </ul>

        </div>

    </div>
</nav>


<div class="container-fluid">
    <div class="row flex-xl-nowrap">
        <div class="col-12 col-md-3 col-xl-2 docs-sidebar pb-5" id="sidebar"></div>


        <div class="d-none d-xl-block col-xl-2 docs-toc">
    <div id="pageContents">
        <ul class="section-nav"></ul>
    </div>
</div>


        <main class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 cas-docs-content" role="main">


            

            <section>
                <nav id="docsNavBar">
                    <span id="toolbarIcons"></span>
                </nav>

                <div id="cas-docs-container">
                    <h1 id="jpa-ticket-registry">JPA Ticket Registry</h1>
<p>The JPA Ticket Registry allows CAS to store client authenticated state data (tickets) in a database back-end such as MySQL.</p>

<div class="alert alert-warning"><strong>Usage Warning!</strong><p>Using a RDBMS as the back-end persistence choice for Ticket Registry state management is a fairly unnecessary and complicated process. Ticket registries generally do not need the durability that comes with RDBMS and unless you are already outfitted with clustered RDBMS technology and the resources to manage it, the complexity is likely not worth the trouble. Given the proliferation of hardware virtualization and the redundancy and vertical scaling they often provide, more suitable recommendation would be the default in-memory ticket registry for a single node CAS deployment and distributed cache-based registries for higher availability.</p></div>

<h1 id="configuration">Configuration</h1>

<ul>
  <li>Adjust the <code class="language-plaintext highlighter-rouge">src/main/webapp/WEB-INF/spring-configuration/ticketRegistry.xml</code> with the following:</li>
</ul>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml">    <span class="nt">&lt;bean</span>
            <span class="na">id=</span><span class="s">"dataSource"</span>
            <span class="na">class=</span><span class="s">"com.mchange.v2.c3p0.ComboPooledDataSource"</span>
            <span class="na">p:driverClass=</span><span class="s">"${database.driverClass:org.hsqldb.jdbcDriver}"</span>
            <span class="na">p:jdbcUrl=</span><span class="s">"${database.url:jdbc:hsqldb:mem:cas-ticket-registry}"</span>
            <span class="na">p:user=</span><span class="s">"${database.user:sa}"</span>
            <span class="na">p:password=</span><span class="s">"${database.password:}"</span>
            <span class="na">p:initialPoolSize=</span><span class="s">"${database.pool.minSize:6}"</span>
            <span class="na">p:minPoolSize=</span><span class="s">"${database.pool.minSize:6}"</span>
            <span class="na">p:maxPoolSize=</span><span class="s">"${database.pool.maxSize:18}"</span>
            <span class="na">p:maxIdleTimeExcessConnections=</span><span class="s">"${database.pool.maxIdleTime:1000}"</span>
            <span class="na">p:checkoutTimeout=</span><span class="s">"${database.pool.maxWait:2000}"</span>
            <span class="na">p:acquireIncrement=</span><span class="s">"${database.pool.acquireIncrement:16}"</span>
            <span class="na">p:acquireRetryAttempts=</span><span class="s">"${database.pool.acquireRetryAttempts:5}"</span>
            <span class="na">p:acquireRetryDelay=</span><span class="s">"${database.pool.acquireRetryDelay:2000}"</span>
            <span class="na">p:idleConnectionTestPeriod=</span><span class="s">"${database.pool.idleConnectionTestPeriod:30}"</span>
            <span class="na">p:preferredTestQuery=</span><span class="s">"${database.pool.connectionHealthQuery:select 1}"</span>
    <span class="nt">/&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"ticketRegistry"</span> <span class="na">class=</span><span class="s">"org.jasig.cas.ticket.registry.JpaTicketRegistry"</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">"org.springframework.orm.jpa.support.PersistenceAnnotationBeanPostProcessor"</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;util:list</span> <span class="na">id=</span><span class="s">"packagesToScan"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;value&gt;</span>org.jasig.cas.ticket<span class="nt">&lt;/value&gt;</span>
        <span class="nt">&lt;value&gt;</span>org.jasig.cas.adaptors.jdbc<span class="nt">&lt;/value&gt;</span>
    <span class="nt">&lt;/util:list&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">"org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter"</span>
          <span class="na">id=</span><span class="s">"jpaVendorAdapter"</span>
          <span class="na">p:generateDdl=</span><span class="s">"true"</span>
          <span class="na">p:showSql=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"entityManagerFactory"</span>
          <span class="na">class=</span><span class="s">"org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean"</span>
          <span class="na">p:dataSource-ref=</span><span class="s">"dataSource"</span>
          <span class="na">p:jpaVendorAdapter-ref=</span><span class="s">"jpaVendorAdapter"</span>
          <span class="na">p:packagesToScan-ref=</span><span class="s">"packagesToScan"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"jpaProperties"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;props&gt;</span>
                <span class="nt">&lt;prop</span> <span class="na">key=</span><span class="s">"hibernate.dialect"</span><span class="nt">&gt;</span>${database.dialect:org.hibernate.dialect.HSQLDialect}<span class="nt">&lt;/prop&gt;</span>
                <span class="nt">&lt;prop</span> <span class="na">key=</span><span class="s">"hibernate.hbm2ddl.auto"</span><span class="nt">&gt;</span>create-drop<span class="nt">&lt;/prop&gt;</span>
                <span class="nt">&lt;prop</span> <span class="na">key=</span><span class="s">"hibernate.jdbc.batch_size"</span><span class="nt">&gt;</span>${database.batchSize:1}<span class="nt">&lt;/prop&gt;</span>
            <span class="nt">&lt;/props&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"transactionManager"</span> <span class="na">class=</span><span class="s">"org.springframework.orm.jpa.JpaTransactionManager"</span>
          <span class="na">p:entityManagerFactory-ref=</span><span class="s">"entityManagerFactory"</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;tx:advice</span> <span class="na">id=</span><span class="s">"txCentralAuthenticationServiceAdvice"</span> <span class="na">transaction-manager=</span><span class="s">"transactionManager"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;tx:attributes&gt;</span>
            <span class="nt">&lt;tx:method</span> <span class="na">name=</span><span class="s">"destroyTicketGrantingTicket"</span> <span class="na">read-only=</span><span class="s">"false"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;tx:method</span> <span class="na">name=</span><span class="s">"grantServiceTicket"</span> <span class="na">read-only=</span><span class="s">"false"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;tx:method</span> <span class="na">name=</span><span class="s">"delegateTicketGrantingTicket"</span> <span class="na">read-only=</span><span class="s">"false"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;tx:method</span> <span class="na">name=</span><span class="s">"validateServiceTicket"</span> <span class="na">read-only=</span><span class="s">"false"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;tx:method</span> <span class="na">name=</span><span class="s">"createTicketGrantingTicket"</span> <span class="na">read-only=</span><span class="s">"false"</span> <span class="nt">/&gt;</span>

            <span class="nt">&lt;tx:method</span> <span class="na">name=</span><span class="s">"getTicket"</span> <span class="na">read-only=</span><span class="s">"false"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;tx:method</span> <span class="na">name=</span><span class="s">"getTickets"</span> <span class="na">read-only=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/tx:attributes&gt;</span>
    <span class="nt">&lt;/tx:advice&gt;</span>

    <span class="nt">&lt;tx:advice</span> <span class="na">id=</span><span class="s">"txRegistryAdvice"</span> <span class="na">transaction-manager=</span><span class="s">"transactionManager"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;tx:attributes&gt;</span>
            <span class="nt">&lt;tx:method</span> <span class="na">name=</span><span class="s">"deleteTicket"</span> <span class="na">read-only=</span><span class="s">"false"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;tx:method</span> <span class="na">name=</span><span class="s">"addTicket"</span> <span class="na">read-only=</span><span class="s">"false"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;tx:method</span> <span class="na">name=</span><span class="s">"updateTicket"</span> <span class="na">read-only=</span><span class="s">"false"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;tx:method</span> <span class="na">name=</span><span class="s">"getTicket"</span> <span class="na">read-only=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;tx:method</span> <span class="na">name=</span><span class="s">"getTickets"</span> <span class="na">read-only=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;tx:method</span> <span class="na">name=</span><span class="s">"sessionCount"</span> <span class="na">read-only=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;tx:method</span> <span class="na">name=</span><span class="s">"serviceTicketCount"</span> <span class="na">read-only=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/tx:attributes&gt;</span>
    <span class="nt">&lt;/tx:advice&gt;</span>

    <span class="nt">&lt;tx:advice</span> <span class="na">id=</span><span class="s">"txRegistryServiceTicketDelegatorAdvice"</span> <span class="na">transaction-manager=</span><span class="s">"transactionManager"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;tx:attributes&gt;</span>
            <span class="nt">&lt;tx:method</span> <span class="na">name=</span><span class="s">"grantTicketGrantingTicket"</span> <span class="na">read-only=</span><span class="s">"false"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/tx:attributes&gt;</span>
    <span class="nt">&lt;/tx:advice&gt;</span>

    <span class="nt">&lt;tx:advice</span> <span class="na">id=</span><span class="s">"txRegistryTicketGrantingTicketDelegatorAdvice"</span> <span class="na">transaction-manager=</span><span class="s">"transactionManager"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;tx:attributes&gt;</span>
            <span class="nt">&lt;tx:method</span> <span class="na">name=</span><span class="s">"markTicketExpired"</span> <span class="na">read-only=</span><span class="s">"false"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;tx:method</span> <span class="na">name=</span><span class="s">"grantServiceTicket"</span> <span class="na">read-only=</span><span class="s">"false"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/tx:attributes&gt;</span>
    <span class="nt">&lt;/tx:advice&gt;</span>

    <span class="nt">&lt;tx:advice</span> <span class="na">id=</span><span class="s">"txRegistryLockingAdvice"</span> <span class="na">transaction-manager=</span><span class="s">"transactionManager"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;tx:attributes&gt;</span>
            <span class="nt">&lt;tx:method</span> <span class="na">name=</span><span class="s">"getOwner"</span> <span class="na">read-only=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;tx:method</span> <span class="na">name=</span><span class="s">"acquire"</span> <span class="na">read-only=</span><span class="s">"false"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;tx:method</span> <span class="na">name=</span><span class="s">"release"</span> <span class="na">read-only=</span><span class="s">"false"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/tx:attributes&gt;</span>
    <span class="nt">&lt;/tx:advice&gt;</span>

    <span class="nt">&lt;aop:config&gt;</span>
        <span class="nt">&lt;aop:pointcut</span> <span class="na">id=</span><span class="s">"ticketRegistryOperations"</span> <span class="na">expression=</span><span class="s">"execution(* org.jasig.cas.ticket.registry.JpaTicketRegistry.*(..))"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;aop:pointcut</span> <span class="na">id=</span><span class="s">"ticketRegistryLockingOperations"</span> <span class="na">expression=</span><span class="s">"execution(* org.jasig.cas.ticket.registry.support.JpaLockingStrategy.*(..))"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;aop:pointcut</span> <span class="na">id=</span><span class="s">"ticketRegistryServiceTicketDelegatorOperations"</span> <span class="na">expression=</span><span class="s">"execution(* org.jasig.cas.ticket.registry.AbstractDistributedTicketRegistry$ServiceTicketDelegator.*(..))"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;aop:pointcut</span> <span class="na">id=</span><span class="s">"ticketRegistryTicketGrantingTicketDelegatorOperations"</span> <span class="na">expression=</span><span class="s">"execution(* org.jasig.cas.ticket.registry.AbstractDistributedTicketRegistry$TicketGrantingTicketDelegator.*(..))"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;aop:pointcut</span> <span class="na">id=</span><span class="s">"casOperations"</span> <span class="na">expression=</span><span class="s">"execution(* org.jasig.cas.CentralAuthenticationServiceImpl.*(..))"</span><span class="nt">/&gt;</span>

        <span class="nt">&lt;aop:advisor</span> <span class="na">advice-ref=</span><span class="s">"txRegistryAdvice"</span> <span class="na">pointcut-ref=</span><span class="s">"ticketRegistryOperations"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;aop:advisor</span> <span class="na">advice-ref=</span><span class="s">"txRegistryLockingAdvice"</span> <span class="na">pointcut-ref=</span><span class="s">"ticketRegistryLockingOperations"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;aop:advisor</span> <span class="na">advice-ref=</span><span class="s">"txRegistryTicketGrantingTicketDelegatorAdvice"</span> <span class="na">pointcut-ref=</span><span class="s">"ticketRegistryTicketGrantingTicketDelegatorOperations"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;aop:advisor</span> <span class="na">advice-ref=</span><span class="s">"txRegistryServiceTicketDelegatorAdvice"</span> <span class="na">pointcut-ref=</span><span class="s">"ticketRegistryServiceTicketDelegatorOperations"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;aop:advisor</span> <span class="na">advice-ref=</span><span class="s">"txCentralAuthenticationServiceAdvice"</span> <span class="na">pointcut-ref=</span><span class="s">"casOperations"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/aop:config&gt;</span>


    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"ticketRegistryCleaner"</span>
          <span class="na">class=</span><span class="s">"org.jasig.cas.ticket.registry.support.DefaultTicketRegistryCleaner"</span>
          <span class="na">c:centralAuthenticationService-ref=</span><span class="s">"centralAuthenticationService"</span>
          <span class="na">c:ticketRegistry-ref=</span><span class="s">"ticketRegistry"</span>
          <span class="na">p:lock-ref=</span><span class="s">"cleanerLock"</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"cleanerLock"</span> <span class="na">class=</span><span class="s">"org.jasig.cas.ticket.registry.support.JpaLockingStrategy"</span>
          <span class="na">p:uniqueId=</span><span class="s">"${host.name}"</span>
          <span class="na">p:applicationId=</span><span class="s">"cas-ticket-registry-cleaner"</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"jobDetailTicketRegistryCleaner"</span>
          <span class="na">class=</span><span class="s">"org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean"</span>
          <span class="na">p:targetObject-ref=</span><span class="s">"ticketRegistryCleaner"</span>
          <span class="na">p:targetMethod=</span><span class="s">"clean"</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"triggerJobDetailTicketRegistryCleaner"</span>
          <span class="na">class=</span><span class="s">"org.springframework.scheduling.quartz.SimpleTriggerFactoryBean"</span>
          <span class="na">p:jobDetail-ref=</span><span class="s">"jobDetailTicketRegistryCleaner"</span>
          <span class="na">p:startDelay=</span><span class="s">"20000"</span>
          <span class="na">p:repeatInterval=</span><span class="s">"5000000"</span> <span class="nt">/&gt;</span></code></pre></figure>

<p>The above snippet assumes that data source information and connection details are defined.</p>

<ul>
  <li>Configure other JPA dependencies:</li>
</ul>

<p>In the <code class="language-plaintext highlighter-rouge">pom.xml</code> file of the Maven overlay, adjust for the following dependencies:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml">...
<span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.jasig.cas<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>cas-server-support-jdbc<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>${cas.version}<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>

<span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.hibernate<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>hibernate-entitymanager<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>${hibernate.core.version}<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;scope&gt;</span>runtime<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>

<span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>com.mchange<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>c3p0<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>${c3p0.version}<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
...</code></pre></figure>

<h2 id="cleaner-locking-strategy">Cleaner Locking Strategy</h2>
<p>The above shows a JPA 2.0 implementation of an exclusive, non-reentrant lock, <code class="language-plaintext highlighter-rouge">JpaLockingStrategy</code>, to be used with the JPA-backed ticket registry.</p>

<p>This will configure the cleaner with the following defaults:</p>

<ul>
  <li>tableName = “LOCKS”</li>
  <li>uniqueIdColumnName = “UNIQUE_ID”</li>
  <li>applicationIdColumnName = “APPLICATION_ID”</li>
  <li>expirationDataColumnName = “EXPIRATION_DATE”</li>
  <li>platform = SQL92</li>
  <li>lockTimeout = 3600 (1 hour)</li>
</ul>

<h1 id="database-configuration">Database Configuration</h1>

<h2 id="jdbc-driver">JDBC Driver</h2>
<p>CAS must have access to the appropriate JDBC driver for the database. Once you have obtained the appropriate driver and configured the data source, place the JAR inside the lib directory of your web server environment (i.e. <code class="language-plaintext highlighter-rouge">$TOMCAT_HOME/lib</code>)</p>

<h2 id="schema">Schema</h2>
<p>If the user has sufficient privileges on start up, the database tables should be created. The database user MUST have <code class="language-plaintext highlighter-rouge">CREATE/ALTER</code> privileges to take advantage of automatic schema generation and schema updates.</p>

<h2 id="deadlocks">Deadlocks</h2>
<p>The Hibernate <code class="language-plaintext highlighter-rouge">SchemaExport</code> DDL creation tool <em>may</em> fail to create two very import indices when generating the ticket tables. The absence of these indices dramatically increases the potential for database deadlocks under load.
If the indices were not created you should manually create them before placing your CAS configuration into a production environment.</p>

<p>To review indices, you may use the following MYSQL-based sample code below:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">show</span> <span class="k">index</span> <span class="k">from</span> <span class="n">SERVICETICKET</span> <span class="k">where</span> <span class="k">column_name</span><span class="o">=</span><span class="s1">'ticketGrantingTicket_ID'</span><span class="p">;</span>
<span class="k">show</span> <span class="k">index</span> <span class="k">from</span> <span class="n">TICKETGRANTINGTICKET</span> <span class="k">where</span> <span class="k">column_name</span><span class="o">=</span><span class="s1">'ticketGrantingTicket_ID'</span><span class="p">;</span></code></pre></figure>

<p>To create indices that are missing, you may use the following sample code below:</p>

<h3 id="mysql">MYSQL</h3>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">ST_TGT_FK_I</span> <span class="k">ON</span> <span class="n">SERVICETICKET</span> <span class="p">(</span><span class="n">ticketGrantingTicket_ID</span><span class="p">);</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">ST_TGT_FK_I</span> <span class="k">ON</span> <span class="n">TICKETGRANTINGTICKET</span> <span class="p">(</span><span class="n">ticketGrantingTicket_ID</span><span class="p">);</span></code></pre></figure>

<h3 id="oracle">ORACLE</h3>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">CREATE</span> <span class="k">INDEX</span> <span class="nv">"ST_TGT_FK_I"</span>
  <span class="k">ON</span> <span class="n">SERVICETICKET</span> <span class="p">(</span><span class="nv">"TICKETGRANTINGTICKET_ID"</span><span class="p">)</span>
  <span class="n">COMPUTE</span> <span class="k">STATISTICS</span><span class="p">;</span>
 
<span class="cm">/** Create index on TGT self-referential foreign-key constraint */</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="nv">"TGT_TGT_FK_I"</span>
  <span class="k">ON</span> <span class="n">TICKETGRANTINGTICKET</span> <span class="p">(</span><span class="nv">"TICKETGRANTINGTICKET_ID"</span><span class="p">)</span>
  <span class="n">COMPUTE</span> <span class="k">STATISTICS</span><span class="p">;</span></code></pre></figure>

<h2 id="ticket-cleanup">Ticket Cleanup</h2>

<p>The use <code class="language-plaintext highlighter-rouge">JpaLockingStrategy</code> is strongly recommended for HA environments where multiple nodes are attempting ticket cleanup on a shared database. <code class="language-plaintext highlighter-rouge">JpaLockingStrategy</code> can auto-generate the schema for the target platform.  A representative schema is provided below that applies to PostgreSQL:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">locks</span> <span class="p">(</span>
 <span class="n">application_id</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
 <span class="n">unique_id</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="k">NULL</span><span class="p">,</span>
 <span class="n">expiration_date</span> <span class="nb">TIMESTAMP</span> <span class="k">NULL</span>
<span class="p">);</span>

<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">locks</span> <span class="k">ADD</span> <span class="k">CONSTRAINT</span> <span class="n">pk_locks</span>
 <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">application_id</span><span class="p">);</span></code></pre></figure>

<div class="alert alert-warning"><strong>Platform-Specific Issues</strong><p>The exact DDL to create the LOCKS table may differ from the above. For example, on Oracle platforms the `expiration_date` column must be of type `DAT`E.  Use the `JpaLockingStrategy` which can create and update the schema automatically to avoid platform-specific schema issues.</p></div>

<h2 id="connection-pooling">Connection Pooling</h2>

<p>The following configuration parameters are provided for information only and may serve as a reasonable 
starting point for configuring a production database connection pool.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># == Basic database connection pool configuration ==</span>
database.dialect<span class="o">=</span>org.hibernate.dialect.PostgreSQLDialect
database.driverClass<span class="o">=</span>org.postgresql.Driver
database.url<span class="o">=</span>jdbc:postgresql://somehost.vt.edu/cas?ssl<span class="o">=</span><span class="nb">true
</span>database.user<span class="o">=</span>somebody
database.password<span class="o">=</span>meaningless
database.pool.minSize<span class="o">=</span>6
database.pool.maxSize<span class="o">=</span>18
 
<span class="c"># Maximum amount of time to wait in ms for a connection to become</span>
<span class="c"># available when the pool is exhausted</span>
database.pool.maxWait<span class="o">=</span>10000
 
<span class="c"># Amount of time in seconds after which idle connections</span>
<span class="c"># in excess of minimum size are pruned.</span>
database.pool.maxIdleTime<span class="o">=</span>120
 
<span class="c"># Number of connections to obtain on pool exhaustion condition.</span>
<span class="c"># The maximum pool size is always respected when acquiring</span>
<span class="c"># new connections.</span>
database.pool.acquireIncrement<span class="o">=</span>6
 
<span class="c"># == Connection testing settings ==</span>
 
<span class="c"># Period in s at which a health query will be issued on idle</span>
<span class="c"># connections to determine connection liveliness.</span>
database.pool.idleConnectionTestPeriod<span class="o">=</span>30
 
<span class="c"># Query executed periodically to test health</span>
database.pool.connectionHealthQuery<span class="o">=</span><span class="k">select </span>1
 
<span class="c"># == Database recovery settings ==</span>
 
<span class="c"># Number of times to retry acquiring a _new_ connection</span>
<span class="c"># when an error is encountered during acquisition.</span>
database.pool.acquireRetryAttempts<span class="o">=</span>5
 
<span class="c"># Amount of time in ms to wait between successive aquire retry attempts.</span>
database.pool.acquireRetryDelay<span class="o">=</span>2000</code></pre></figure>

<p>The following maven dependency for the library must be included in your Maven overlay:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>c3p0<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>c3p0<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>${c3p0.version}<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;scope&gt;</span>runtime<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre></figure>

<h1 id="platform-considerations">Platform Considerations</h1>

<h2 id="mysql-1">MySQL</h2>

<h3 id="use-innodb-tables">Use InnoDB Tables</h3>
<p>The use of InnoDB tables is strongly recommended for the MySQL platform for a couple reasons:</p>

<ul>
  <li>InnoDB provides referential integrity that is helpful for preventing orphaned records in ticket tables.</li>
  <li>Provides better locking semantics (e.g. support for SELECT … FOR UPDATE) than the default MyISAM table type.</li>
</ul>

<p>InnoDB tables are easily specified via the use of the following Hibernate dialect:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;prop</span> <span class="na">key=</span><span class="s">"hibernate.dialect"</span><span class="nt">&gt;</span>org.hibernate.dialect.MySQLInnoDBDialect<span class="nt">&lt;/prop&gt;</span>
 
<span class="c">&lt;!-- OR for MySQL 5.x use the following instead --&gt;</span>
<span class="nt">&lt;prop</span> <span class="na">key=</span><span class="s">"hibernate.dialect"</span><span class="nt">&gt;</span>org.hibernate.dialect.MySQL5InnoDBDialect<span class="nt">&lt;/prop&gt;</span></code></pre></figure>

<h3 id="blob-vs-longblob">BLOB vs LONGBLOB</h3>
<p>Hibernate on recent versions of MySQL (e.g. 5.1) properly maps the <code class="language-plaintext highlighter-rouge">@Lob</code> JPA annotation onto type <code class="language-plaintext highlighter-rouge">LONGBLOB</code>, which is very important since these fields commonly store serialized graphs of Java objects that grow proportionally with CAS SSO session lifetime. Under some circumstances, Hibernate may treat these columns as type <code class="language-plaintext highlighter-rouge">BLOB</code>, which have storage limits that are easily exceeded. It is recommended that the generated schema be reviewed and any BLOB type columns be converted to <code class="language-plaintext highlighter-rouge">LONGBLOB</code>.</p>

<p>The following MySQL statement would change this <code class="language-plaintext highlighter-rouge">SERVICES_GRANTED_ACCESS_TO</code> column’s type to <code class="language-plaintext highlighter-rouge">LONGBLOB</code>:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">TICKETGRANTINGTICKET</span> <span class="k">MODIFY</span> <span class="n">SERVICES_GRANTED_ACCESS_TO</span> <span class="nb">LONGBLOB</span><span class="p">;</span></code></pre></figure>

<h3 id="case-sensitive-schema">Case Sensitive Schema</h3>
<p>It may necessary to force lowercase schema names in the MySQL configuration:</p>

<p>Adjust the <code class="language-plaintext highlighter-rouge">my.cnf</code> file to include the following:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">lower-case-table-names <span class="o">=</span> 1</code></pre></figure>


                </div>
            </section>
        </main>
    </div>
</div>


<footer>
    <div class="container">
        CAS is supported by the <a href="https://www.apereo.org/">Apereo Foundation</a>.
    </div>
</footer>

<script>
    let pageSection = '';
</script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.3.2/js/tether.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js"></script>

<script src="../../javascripts/URI.js"></script>
<script src="../../javascripts/main.js"></script>

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@docsearch/js@3"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
</body>

</html>

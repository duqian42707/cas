<!DOCTYPE html>
<html>

<head>
    <!-- Required meta tags always come first -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="description" content="CAS - Enterprise Single Sign-On for the Web"/>
    <meta name="keywords" content="authentication, login, cas, central authentication service, web, java, protocol, thymeleaf,
                   open source, boot, spring, authorization, google, facebook, twitter, higher-ed, enterprise,
                   access management, single signon, sso, RBAC, ABAC, attributes, SAML, OpenID, openid connect,
                   JWT, ADFS"/>
    <meta name="robots" content="index,follow"/>

    
    

        
    


    

    <script>
        ((i, s, o, g, r, a, m) => {
            i['GoogleAnalyticsObject'] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o),
                m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m)
        })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

        ga('create', 'UA-83384532-2', 'auto');
        ga('send', 'pageview');

    </script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.3/css/all.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css@3"/>

    <link rel="stylesheet" type="text/css" media="screen" href="../../stylesheets/stylesheet.css">
    <link rel="stylesheet" type="text/css" media="print" href="../../stylesheets/print.css">

    <link href='https://fonts.googleapis.com/css?family=Lato:400,300,700' rel='stylesheet'>
    <link href='https://fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic&subset=latin-ext,latin' rel='stylesheet'>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@100;200;300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css" rel="stylesheet">

    <title>CAS - ClearPass</title>

</head>

<body>
<!-- HEADER -->
<header class="hidden-sm-down">
    <div class="container">
        <div class="row">
            <div class="col-xs-4 col-md-2">
                <a href="../../index.html">
                    <img class="undecorated" src="../../images/cas_logo.png"/>
                </a>
            </div>
            <div class="col-xs-8 col-md-6">
                <h1>Enterprise Single Sign-On for All</h1>
            </div>
            <div class="hidden-sm-down col-md-4">
                <a id="forkme_banner" href="https://github.com/apereo/cas">View on GitHub</a>
            </div>

        </div>
    </div>
</header>

<!-- NAVBAR -->

<nav class="navbar navbar-expand-md navbar-dark bg-primary bg-dark">
    <div class="container">
        <button class="navbar-toggler collapsed" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarsExample04" aria-controls="navbarsExample04" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="navbar-collapse collapse" id="navbarsExample04">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item active"><a href="../../index.html" class="zoom nav-link">Home</a></li>
                <li class="nav-item"><a href="https://github.com/apereo/cas/releases" class="zoom nav-link">Releases</a></li>
                <li class="nav-item"><a href="../../Support.html" class="zoom nav-link">Support</a></li>
                <li class="nav-item"><a href="../../Mailing-Lists.html" class="zoom nav-link">Mailing Lists</a></li>
                <li class="nav-item">
                    <a class="zoom nav-link" href="../../Demos.html">Demos</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="zoom nav-link dropdown-toggle mr-md-2" href="#" id="cas-versions" data-bs-toggle="dropdown"
                       aria-haspopup="true" aria-expanded="false">Versions</a>
                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="cas-versions">
                        
                        
                        <a class="dropdown-item" href="/cas/development/">Development</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/6.6.x/">v6.6.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/6.5.x/">v6.5.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/6.4.x/">v6.4.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/6.3.x/">v6.3.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/6.2.x/">v6.2.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/6.1.x/">v6.1.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/6.0.x/">v6.0.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/5.3.x/">v5.3.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/5.2.x/">v5.2.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/5.1.x/">v5.1.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/5.0.x/">v5.0.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/4.2.x/">v4.2.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/4.1.x/">v4.1.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/4.0.x/">v4.0.x</a>
                        
                        

                    </div>
                </li>
                <li class="nav-item"><a href="https://apereo.github.io" target="_blank" class="zoom nav-link">Blog</a></li>
            </ul>

        </div>

    </div>
</nav>


<div class="container-fluid">
    <div class="row flex-xl-nowrap">
        <div class="col-12 col-md-3 col-xl-2 docs-sidebar pb-5" id="sidebar"></div>


        <div class="d-none d-xl-block col-xl-2 docs-toc">
    <div id="pageContents">
        <ul class="section-nav"></ul>
    </div>
</div>


        <main class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 cas-docs-content" role="main">


            

            <section>
                <nav id="docsNavBar">
                    <span id="toolbarIcons"></span>
                </nav>

                <div id="cas-docs-container">
                    <h1 id="clearpass-credential-caching-and-replay">ClearPass: Credential Caching and Replay</h1>

<p>To enable single sign-on into some legacy applications it may be necessary to provide them with the actual password.
While such approach inevitably increases security risk, at times this may be a necessary evil in order to integrate
applications with CAS.</p>

<div class="alert alert-warning"><strong>Usage Warning!</strong><p>ClearPass is turned off by default.
No applications will be able to obtain the user credentials unless ClearPass is explicitly turned on by the
below configuration. Think <strong>VERY CAREFULLY</strong> before turning on this feature, as it <strong>MUST</strong> be
the last resort in getting an integration to work...maybe not even then.</p></div>

<h2 id="overview">Overview</h2>

<p>CAS is able to issue the credential password directly in the CAS validation response. This previously was handled
via a proxy authentication sequence and obtaining a proxy-granting ticket for the ClearPass service and was necessary
in order to establish trust between the client application and the CAS server. This document describes the configuration
that can be applied in order to receive the credential password as an attribute in the CAS validation response.</p>

<p>In order to successfully establish trust between the
CAS server and the application, private/public key pairs are generated by the client application and then
<strong>the public key</strong> distributed and configured inside CAS. CAS will use the public key to encrypt the credential
password and will issue a new attribute <code class="language-plaintext highlighter-rouge">&lt;credential&gt;</code> in the validation response, only if the service is authorized to receive it.</p>

<p>Note that the return of the credential is only carried out by the CAS validation response, provided the client
application issues a request to the <code class="language-plaintext highlighter-rouge">/p3/serviceValidate</code> endpoint  (or <code class="language-plaintext highlighter-rouge">/p3/proxyValidate</code>). Other means of
returning attributes to CAS, such as SAML1 will <strong>not</strong> support the additional returning of this value.</p>

<p>Also note that CAS by default attempts to encrypt the cached credential in memory via its own pre-generated keys
for signing and encryption. When the attribute is to be released to the application, CAS will internally decode
the credential first and then will attempt to encrypt it again this time using the service’s public key credentials.
This behavior can be controlled via <a href="../installation/Configuration-Properties.html#clearpass">settings</a>.</p>

<div class="alert alert-info"><strong>ClearPass via Proxying!</strong><p>CAS no longer supports retrieving
the credential via the proxying mechanism. Applications that intend to obtain the credential
need to be updated to account for the following approach described here.</p></div>

<h2 id="cache-credential">Cache Credential</h2>

<p>Enable the caching and capturing of the credential in CAS properties.
To see the relevant list of CAS properties, please <a href="../installation/Configuration-Properties.html#clearpass">review this guide</a>.</p>

<h2 id="create-keys">Create Keys</h2>

<p>The keypair must be generated by the application itself that wishes to obtain the user credential.
The public key is shared with CAS. The private key is used by the application to decrypt the credential.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>openssl genrsa <span class="nt">-out</span> private.key 1024
openssl rsa <span class="nt">-pubout</span> <span class="nt">-in</span> private.key <span class="nt">-out</span> public.key <span class="nt">-inform</span> PEM <span class="nt">-outform</span> DER
openssl pkcs8 <span class="nt">-topk8</span> <span class="nt">-inform</span> PER <span class="nt">-outform</span> DER <span class="nt">-nocrypt</span> <span class="nt">-in</span> private.key <span class="nt">-out</span> private.p8
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Note that while <code class="language-plaintext highlighter-rouge">1024</code> is perfectly fine, you may need to adjust the key size to larger values such
as <code class="language-plaintext highlighter-rouge">4096</code> in order to allow CAS to encrypt credentials that are too long in length.</p>

<h2 id="register-public-key">Register Public Key</h2>

<p>Once you have received the public key from the client application owner, it must be first
registered inside the CAS server’s service registry. The service that holds the public key above must also
be authorized to receive the password as an attribute for the given attribute release policy of choice.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"@class"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"org.apereo.cas.services.RegexRegisteredService"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"serviceId"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"^https://.+"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"attributeReleasePolicy"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"@class"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"org.apereo.cas.services.ReturnAllowedAttributeReleasePolicy"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"authorizedToReleaseCredentialPassword"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"publicKey"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"@class"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"org.apereo.cas.services.RegisteredServicePublicKeyImpl"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"location"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"classpath:public.key"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"algorithm"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"RSA"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="decrypt-the-password">Decrypt the Password</h2>

<p>Once the client application has received the <code class="language-plaintext highlighter-rouge">credential</code> attribute in the CAS validation response, it can decrypt
it via its own private key. Since the attribute is base64 encoded by default, it needs to be decoded first before
decryption can occur. Here’s a sample code snippet:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;?,</span> <span class="o">?&gt;</span> <span class="n">attributes</span> <span class="o">=</span> <span class="o">...</span>
<span class="kd">final</span> <span class="nc">String</span> <span class="n">encodedPsw</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">attributes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"credential"</span><span class="o">);</span>

<span class="cm">/* Use the private.key file generated above. */</span>
<span class="kd">final</span> <span class="nc">PrivateKey</span> <span class="n">privateKey</span> <span class="o">=</span> <span class="o">...</span>
<span class="kd">final</span> <span class="nc">Cipher</span> <span class="n">cipher</span> <span class="o">=</span> <span class="nc">Cipher</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">privateKey</span><span class="o">.</span><span class="na">getAlgorithm</span><span class="o">());</span>
<span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">cred64</span> <span class="o">=</span> <span class="n">decodeBase64</span><span class="o">(</span><span class="n">encodedPsw</span><span class="o">);</span>
<span class="n">cipher</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="nc">Cipher</span><span class="o">.</span><span class="na">DECRYPT_MODE</span><span class="o">,</span> <span class="n">privateKey</span><span class="o">);</span>
<span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">cipherData</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="na">doFinal</span><span class="o">(</span><span class="n">cred64</span><span class="o">);</span>
<span class="k">return</span> <span class="k">new</span> <span class="nf">String</span><span class="o">(</span><span class="n">cipherData</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

                </div>
            </section>
        </main>
    </div>
</div>


<footer>
    <div class="container">
        CAS is supported by the <a href="https://www.apereo.org/">Apereo Foundation</a>.
    </div>
</footer>

<script>
    let pageSection = '';
</script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.3.2/js/tether.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js"></script>

<script src="../../javascripts/URI.js"></script>
<script src="../../javascripts/main.js"></script>

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@docsearch/js@3"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
</body>

</html>

<!DOCTYPE html>
<html>

<head>
    <!-- Required meta tags always come first -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="description" content="CAS - Enterprise Single Sign-On for the Web"/>
    <meta name="keywords" content="authentication, login, cas, central authentication service, web, java, protocol, thymeleaf,
                   open source, boot, spring, authorization, google, facebook, twitter, higher-ed, enterprise,
                   access management, single signon, sso, RBAC, ABAC, attributes, SAML, OpenID, openid connect,
                   JWT, ADFS"/>
    <meta name="robots" content="index,follow"/>

    
    

        
    


    

    <script>
        ((i, s, o, g, r, a, m) => {
            i['GoogleAnalyticsObject'] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o),
                m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m)
        })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

        ga('create', 'UA-83384532-2', 'auto');
        ga('send', 'pageview');

    </script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.3/css/all.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css@3"/>

    <link rel="stylesheet" type="text/css" media="screen" href="../../stylesheets/stylesheet.css">
    <link rel="stylesheet" type="text/css" media="print" href="../../stylesheets/print.css">

    <link href='https://fonts.googleapis.com/css?family=Lato:400,300,700' rel='stylesheet'>
    <link href='https://fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic&subset=latin-ext,latin' rel='stylesheet'>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@100;200;300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css" rel="stylesheet">

    <title>CAS - Custom Multifactor Authentication</title>

</head>

<body>
<!-- HEADER -->
<header class="hidden-sm-down">
    <div class="container">
        <div class="row">
            <div class="col-xs-4 col-md-2">
                <a href="../../index.html">
                    <img class="undecorated" src="../../images/cas_logo.png"/>
                </a>
            </div>
            <div class="col-xs-8 col-md-6">
                <h1>Enterprise Single Sign-On for All</h1>
            </div>
            <div class="hidden-sm-down col-md-4">
                <a id="forkme_banner" href="https://github.com/apereo/cas">View on GitHub</a>
            </div>

        </div>
    </div>
</header>

<!-- NAVBAR -->

<nav class="navbar navbar-expand-md navbar-dark bg-primary bg-dark">
    <div class="container">
        <button class="navbar-toggler collapsed" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarsExample04" aria-controls="navbarsExample04" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="navbar-collapse collapse" id="navbarsExample04">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item active"><a href="../../index.html" class="zoom nav-link">Home</a></li>
                <li class="nav-item"><a href="https://github.com/apereo/cas/releases" class="zoom nav-link">Releases</a></li>
                <li class="nav-item"><a href="../../Support.html" class="zoom nav-link">Support</a></li>
                <li class="nav-item"><a href="../../Mailing-Lists.html" class="zoom nav-link">Mailing Lists</a></li>
                <li class="nav-item">
                    <a class="zoom nav-link" href="../../Demos.html">Demos</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="zoom nav-link dropdown-toggle mr-md-2" href="#" id="cas-versions" data-bs-toggle="dropdown"
                       aria-haspopup="true" aria-expanded="false">Versions</a>
                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="cas-versions">
                        
                        
                        <a class="dropdown-item" href="/cas/development/">Development</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/6.6.x/">v6.6.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/6.5.x/">v6.5.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/6.4.x/">v6.4.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/6.3.x/">v6.3.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/6.2.x/">v6.2.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/6.1.x/">v6.1.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/6.0.x/">v6.0.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/5.3.x/">v5.3.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/5.2.x/">v5.2.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/5.1.x/">v5.1.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/5.0.x/">v5.0.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/4.2.x/">v4.2.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/4.1.x/">v4.1.x</a>
                        
                        
                        
                        <a class="dropdown-item" href="/cas/4.0.x/">v4.0.x</a>
                        
                        

                    </div>
                </li>
                <li class="nav-item"><a href="https://apereo.github.io" target="_blank" class="zoom nav-link">Blog</a></li>
            </ul>

        </div>

    </div>
</nav>


<div class="container-fluid">
    <div class="row flex-xl-nowrap">
        <div class="col-12 col-md-3 col-xl-2 docs-sidebar pb-5" id="sidebar"></div>


        <div class="d-none d-xl-block col-xl-2 docs-toc">
    <div id="pageContents">
        <ul class="section-nav"></ul>
    </div>
</div>


        <main class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 cas-docs-content" role="main">


            

            <section>
                <nav id="docsNavBar">
                    <span id="toolbarIcons"></span>
                </nav>

                <div id="cas-docs-container">
                    <h1 id="custom-multifactor-authentication">Custom Multifactor Authentication</h1>

<p>To create your own custom multifactor authentication provider, you will need to design components that primarily register a customized authentication flow into the CAS webflow engine under a unique identifier. Later on, you will also need to consider strategies by which your custom multifactor authentication provider <a href="Configuring-Multifactor-Authentication-Triggers.html">can be triggered</a>.</p>

<h2 id="provider-id">Provider ID</h2>

<p>Each multifactor provider is assigned a unique identifier that is typically mapped or made equal to the underlying webflow. The unique identifier can be any arbitrary string of your choosing, provided it’s kept distinct and sensible as it, depending on use case, may be used in other systems and by other applications to act as a trigger.</p>

<p>For the purposes of this guide, let’s choose <code class="language-plaintext highlighter-rouge">mfa-custom</code> as our provider id.</p>

<h2 id="webflow-xml-configuration">Webflow XML Configuration</h2>

<p>The flow configuration file needs to be placed inside a <code class="language-plaintext highlighter-rouge">src/main/resources/webflow/mfa-custom</code> directory, named as <code class="language-plaintext highlighter-rouge">mfa-custom.xml</code> whose outline is sampled below:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;flow</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/webflow"</span>
      <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
      <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/webflow http://www.springframework.org/schema/webflow/spring-webflow.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;var</span> <span class="na">name=</span><span class="s">"credential"</span> <span class="na">class=</span><span class="s">"org.example.CustomCredential"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;on-start&gt;</span>
        <span class="nt">&lt;evaluate</span> <span class="na">expression=</span><span class="s">"initialFlowSetupAction"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/on-start&gt;</span>

    <span class="nt">&lt;action-state</span> <span class="na">id=</span><span class="s">"initializeLoginForm"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;evaluate</span> <span class="na">expression=</span><span class="s">"initializeLoginAction"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;transition</span> <span class="na">on=</span><span class="s">"success"</span> <span class="na">to=</span><span class="s">"viewLoginForm"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/action-state&gt;</span>

    <span class="nt">&lt;view-state</span> <span class="na">id=</span><span class="s">"viewLoginForm"</span> <span class="na">view=</span><span class="s">"..."</span> <span class="na">model=</span><span class="s">"credential"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;binder&gt;</span>
            ...
        <span class="nt">&lt;/binder&gt;</span>
        <span class="nt">&lt;on-entry&gt;</span>
            <span class="nt">&lt;set</span> <span class="na">name=</span><span class="s">"viewScope.principal"</span> <span class="na">value=</span><span class="s">"conversationScope.authentication.principal"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/on-entry&gt;</span>
        <span class="nt">&lt;transition</span> <span class="na">on=</span><span class="s">"submit"</span> <span class="na">bind=</span><span class="s">"true"</span> <span class="na">validate=</span><span class="s">"true"</span> <span class="na">to=</span><span class="s">"realSubmit"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/view-state&gt;</span>

    <span class="nt">&lt;action-state</span> <span class="na">id=</span><span class="s">"realSubmit"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;evaluate</span> <span class="na">expression=</span><span class="s">"finalAuthenticationWebflowAction"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;transition</span> <span class="na">on=</span><span class="s">"success"</span> <span class="na">to=</span><span class="s">"success"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;transition</span> <span class="na">on=</span><span class="s">"error"</span> <span class="na">to=</span><span class="s">"initializeLoginForm"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/action-state&gt;</span>

    <span class="nt">&lt;end-state</span> <span class="na">id=</span><span class="s">"success"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/flow&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="register-webflow-configuration">Register Webflow Configuration</h2>

<p>The custom provider itself is its own standalone webflow that is then registered with the primary authentication flow.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomAuthenticatorWebflowConfigurer</span> <span class="kd">extends</span> <span class="nc">AbstractCasMultifactorWebflowConfigurer</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">MFA_EVENT_ID</span> <span class="o">=</span> <span class="s">"mfa-custom"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">FlowDefinitionRegistry</span> <span class="n">flowDefinitionRegistry</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">CustomAuthenticatorWebflowConfigurer</span><span class="o">(</span><span class="nc">FlowBuilderServices</span> <span class="n">flowBuilderServices</span><span class="o">,</span>
                                                <span class="nc">FlowDefinitionRegistry</span> <span class="n">loginFlowDefinitionRegistry</span><span class="o">,</span>
                                                <span class="nc">FlowDefinitionRegistry</span> <span class="n">flowDefinitionRegistry</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">flowBuilderServices</span><span class="o">,</span> <span class="n">loginFlowDefinitionRegistry</span><span class="o">,</span> <span class="n">flowDefinitionRegistry</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">flowDefinitionRegistry</span> <span class="o">=</span> <span class="n">flowDefinitionRegistry</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doInitialize</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="n">registerMultifactorProviderAuthenticationWebflow</span><span class="o">(</span><span class="n">getLoginFlow</span><span class="o">(),</span>
                <span class="no">MFA_EVENT_ID</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">flowDefinitionRegistry</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="design-provider">Design Provider</h2>

<p>Multifactor authentication providers in CAS are represented in forms of <code class="language-plaintext highlighter-rouge">MultifactorAuthenticationProvider</code> instances.
The outline of the provider is briefly displayed below and much of its behavior is removed in favor of defaults.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomMultifactorAuthenticationProvider</span> <span class="kd">extends</span> <span class="nc">AbstractMultifactorAuthenticationProvider</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">4789727148634156909L</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="register-provider">Register Provider</h2>

<p>The custom webflow configuration needs to be registered with CAS. The outline of the configuration registration is sampled and summarized below:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">org.example.cas</span><span class="o">;</span>

<span class="nd">@Configuration</span><span class="o">(</span><span class="s">"CustomAuthenticatorSubsystemConfiguration"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomAuthenticatorSubsystemConfiguration</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">FlowDefinitionRegistry</span> <span class="nf">customFlowRegistry</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">FlowDefinitionRegistryBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FlowDefinitionRegistryBuilder</span><span class="o">(</span><span class="n">applicationContext</span><span class="o">,</span> <span class="n">flowBuilderServices</span><span class="o">);</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">setBasePath</span><span class="o">(</span><span class="s">"classpath*:/webflow"</span><span class="o">);</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">addFlowLocationPattern</span><span class="o">(</span><span class="s">"/mfa-custom/*-webflow.xml"</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">MultifactorAuthenticationProvider</span> <span class="nf">customAuthenticationProvider</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">CustomMultifactorAuthenticationProvider</span> <span class="n">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CustomMultifactorAuthenticationProvider</span><span class="o">();</span>
        <span class="n">p</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="s">"mfa-custom"</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">p</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">CasWebflowConfigurer</span> <span class="nf">customWebflowConfigurer</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">CustomAuthenticatorWebflowConfigurer</span><span class="o">(</span>
                <span class="n">flowBuilderServices</span><span class="o">,</span>
                <span class="n">loginFlowDefinitionRegistry</span><span class="o">,</span>
                <span class="n">customFlowRegistry</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="o">...</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Do not forget to register the configuration class with CAS. <a href="../configuration/Configuration-Management-Extensions.html">See this guide</a> for better details.</p>

<h2 id="triggers">Triggers</h2>

<p>The custom authentication webflow can be triggered using any of the <a href="Configuring-Multifactor-Authentication-Triggers.html">supported options</a></p>

                </div>
            </section>
        </main>
    </div>
</div>


<footer>
    <div class="container">
        CAS is supported by the <a href="https://www.apereo.org/">Apereo Foundation</a>.
    </div>
</footer>

<script>
    let pageSection = 'Multifactor Authentication';
</script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.3.2/js/tether.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js"></script>

<script src="../../javascripts/URI.js"></script>
<script src="../../javascripts/main.js"></script>

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@docsearch/js@3"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
</body>

</html>
